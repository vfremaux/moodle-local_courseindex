define("local_courseindex/geolocate",["jquery","core/prefetch","core/templates","core/str","core/log","core/config"],(function($,Prefetch,Templates,Strings,log,cfg){var geolocate={map:null,markers:Array(),popupmarkers:Array(),centerloc:null,strs:Array(),init:async function(data){if(!this.map){var zoomLevel;if(Strings.get_strings([{key:"geofetch",component:"local_courseindex"},{key:"geonotfound",component:"local_courseindex"},{key:"geonotfoundwarn",component:"local_courseindex"},{key:"geonotavailable",component:"local_courseindex"}]).then((function(results){this.strs.fetch=results[0],this.strs.notfound=results[1],this.strs.notfoundwarn=results[2],this.strs.notavailable=results[3]})),this.markers=data.markers,this.defaultmapcenter=data.defaultcenterloc,this.defaultzoom=data.defaultzoom,""!=this.defaultmapcenter){var result=await geolocate.geocodeLocation(this.defaultmapcenter);this.centerloc=[result.lat,result.lon]}else this.centerloc=[46.2276,2.2137];for(zoomLevel=this.defaultzoom>0?this.defaultzoom:8,this.map=L.map("map",{zoomControl:!0,attributionControl:!1,dragging:!0,touchZoom:!0,scrollWheelZoom:!0}).setView(this.centerloc,zoomLevel),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:!1,maxZoom:19,minZoom:4,preferCanvas:!0}).addTo(this.map),Prefetch.prefetchTemplate("local_courseindex/geomarker"),log.debug("AMD courseindex geocode initialized"),i=0;i<this.markers.length;i++){let m=this.markers[i],result=await geolocate.geocodeLocation(m.location);geolocate.markers[i].lon=result.lon,geolocate.markers[i].lat=result.lat,geolocate.markers[i].locname=result.name,geolocate.markers[i].locdisplayname=result.displayName,geolocate.addMarker(geolocate.markers[i])}log.debug("AMD courseindex geocode markers initialized"),geolocate.showLocation()}},geocodeLocation:async function(locationName){try{const response=await fetch("https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(locationName)+",France&limit=1",{headers:{"User-Agent":"MoodleFormationMap/1.0"}});if(!response.ok)throw new Error(geolocate.strs.notavailable);const data=await response.json();return data&&data.length>0?{lat:parseFloat(data[0].lat),lon:parseFloat(data[0].lon),name:data[0].name,displayName:data[0].display_name}:null}catch(error){return log.debug("Geocoding error :"+error),null}},addMarker:async function(marker){const icon=L.icon({iconUrl:cfg.wwwroot+"/local/courseindex/pix/location_with_alpha.png",iconSize:[32,40],iconAnchor:[16,40],popupAnchor:[0,-40],title:marker.location,className:"custom-marker"});Templates.render("local_courseindex/geomarker",{hascost:marker.hascost,cost:marker.cost,timestart:marker.timestart,timeend:marker.timeend,coursename:marker.course,location:marker.location,mode:marker.mode}).then((function(html){geolocate.popupmarkers.push(L.marker([marker.lat,marker.lon],{icon:icon}).addTo(geolocate.map).bindPopup(html,{maxWidth:250,maxHeight:250,className:"custom-popup"}).openPopup())})),this.map.setView([marker.lat,marker.lon],12)},showLocation:async function(locationName){geolocate.init();const locationInfo=$("#locationInfo");locationInfo&&locationInfo.html(geolocate.strs.fetch);const location=await geolocate.geocodeLocation(locationName);location?(geolocate.currentLocation=location,geolocate.addMarker(location.lat,location.lon,location.name),locationInfo&&locationInfo.html(location.name)):(locationInfo&&locationInfo.html(geolocate.strs.notfound),log.warn(geolocate.strs.notfoundwarn.replace("{{locname}}",locationName)))},escapeHtml:function(text){if(!text)return"";const map={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(text).replace(/[&<>"']/g,(function(m){return map[m]}))},openMap:function(locationName){const themap=$("#mapOverlay");themap&&(themap.addClass("active"),geolocate.showLocation(locationName))}};return geolocate}));

//# sourceMappingURL=geolocate.min.js.map