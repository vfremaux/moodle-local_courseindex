define("local_courseindex/geolocate",["jquery","core/prefetch","core/templates","core/log"],(function($,Prefetch,Templates,log){var geolocate={map:null,markers:Array(),popupmarkers:Array(),init:function(data){if(!this.map){var centerloc,zoomLevel;if(this.markers=data.markers,this.defaultmapcenter=data.defaultcenterloc,this.defaultzoom=data.defaultzoom,""!=this.defaultmapcenter){var centerlocdata=geolocate.geocodeLocation(this.defaultmapcenter);log.debug(centerlocdata),centerloc=[centerlocdata.lat,centerlocdata.lon]}else centerloc=[46.2276,2.2137];for(zoomLevel=this.defaultzoom>0?this.defaultzoom:6,log.debug(centerloc),this.map=L.map("map",{zoomControl:!0,attributionControl:!1,dragging:!0,touchZoom:!0,scrollWheelZoom:!0}).setView(centerloc,zoomLevel),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:!1,maxZoom:19,minZoom:4,preferCanvas:!0}).addTo(this.map),setTimeout((()=>{this.map&&this.map.invalidateSize()}),350),Prefetch.prefetchTemplate("local_courseindex/geomarker"),log.debug("AMD courseindex geocode initialized"),i=0;i<this.markers.length;i++){let m=this.markers[i],locdata=geolocate.geocodeLocation(m.location);this.markers[i].lon=locdata.lon,this.markers[i].lat=locdata.lat,this.markers[i].locname=locdata.name,this.markers[i].locdisplayname=locdata.displayName,geolocate.addMarker(this.markers[i])}geolocate.showLocation()}},geocodeLocation:async function(locationName){try{const response=await fetch("https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(locationName)+",France&limit=1",{headers:{"User-Agent":"MoodleFormationMap/1.0"}});if(!response.ok)throw new Error("Network error");const data=await response.json();return data&&data.length>0?{lat:parseFloat(data[0].lat),lon:parseFloat(data[0].lon),name:data[0].name,displayName:data[0].display_name}:null}catch(error){return log.debug("Geocoding error :"+error),null}},addMarker:function(marker){const icon=L.icon({iconUrl:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDMyIDQwIj48cGF0aCBkPSJNMTYgMEM4LjI3IDAgMiA2LjI3IDIgMTRjMCA0IDAgMTggMTQgMjZzMTQtMjIgMTQtMjZjMC03LjczLTYuMjctMTQtMTQtMTR6TTEyIDIwYzAgMi4yMiAxLjc4IDQgNCA0czQtMS43OCA0LTQtMS43OC00LTQtNC00IDEuNzgtNCA0eiIgZmlsbD0iIzY2N2VlYSIvPjwvc3ZnPg==",iconSize:[32,40],iconAnchor:[16,40],popupAnchor:[0,-40],title:marker.location,className:"custom-marker"});let popupContent=Templates.render("local_courseindex/geomarker",{hascost:marker.hascost,cost:marker.cost,timestart:marker.timestart,timeend:marker.timeend,coursename:marker.course,location:marker.location,mode:marker.mode});this.popupmarkers.push(L.marker([marker.lat,marker.lon],{icon:icon}).addTo(this.map).bindPopup(popupContent,{maxWidth:250,maxHeight:250,className:"custom-popup"}).openPopup()),this.map.setView([marker.lat,marker.lon],12)},showLocation:async function(locationName){this.initMap();const locationInfo=$("#locationInfo");locationInfo&&locationInfo.html("G?olocalisation en cours...");const location=await this.geocodeLocation(locationName);location?(this.currentLocation=location,this.addMarker(location.lat,location.lon,location.name),locationInfo&&locationInfo.html("?? "+location.name)):(locationInfo&&locationInfo.html("Localisation non trouv?e"),log.warn('La localit? "'+locationName+"\" n'a pas pu ?tre g?olocalis?e"))},escapeHtml:function(text){if(!text)return"";const map={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(text).replace(/[&<>"']/g,(function(m){return map[m]}))},openMap:function(locationName){const themap=$("#mapOverlay");themap&&(themap.addClass("active"),geolocate.showLocation(locationName))}};return geolocate}));

//# sourceMappingURL=geolocate.min.js.map