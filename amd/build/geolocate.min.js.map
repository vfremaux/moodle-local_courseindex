{"version":3,"file":"geolocate.min.js","sources":["../src/geolocate.js"],"sourcesContent":["\n/* eslint no-undef: \"off\" */\n\ndefine(['jquery', 'core/prefetch', 'core/templates',\n        'core/str', 'core/log', 'core/config'], function($, Prefetch, Templates, Strings, log, cfg) {\n\n    var geolocate = {\n\n        map: null,\n\n        markers: Array(),\n\n        popupmarkers: Array(),\n\n        centerloc: null,\n\n        strs: Array(),\n\n        /**\n         * Initialise la carte Leaflet\n         * @param {string} data\n         */\n        init: async function(data) {\n\n            if (geolocate.map) {\n                return;\n            }\n\n            // Fetch some strings.\n            Strings.get_strings([{\n                key: 'geofetch',\n                component: 'local_courseindex'\n            }, {\n                key: 'geonotfound',\n                component: 'local_courseindex'\n            }, {\n                key: 'geonotfoundwarn',\n                component: 'local_courseindex'\n            }, {\n                key: 'geonotavailable',\n                component: 'local_courseindex'\n            }]).then(function(results) {\n                geolocate.strs['fetch'] = results[0];\n                geolocate.strs['notfound'] = results[1];\n                geolocate.strs['notfoundwarn'] = results[2];\n                geolocate.strs['notavailable'] = results[3];\n            });\n\n            var zoomLevel;\n\n            geolocate.markers = data.markers;\n            geolocate.defaultmapcenter = data.defaultcenterloc;\n            geolocate.defaultzoom = data.defaultzoom;\n            if (geolocate.defaultmapcenter != '') {\n                var result = await geolocate.geocodeLocation(geolocate.defaultmapcenter);\n                geolocate.centerloc = [result.lat, result.lon];\n            } else {\n                geolocate.centerloc = [46.2276, 2.2137];\n            }\n\n            if (geolocate.defaultzoom > 0) {\n                zoomLevel = geolocate.defaultzoom;\n            } else {\n                zoomLevel = 8;\n            }\n\n            this.map = L.map('map', {\n                zoomControl: true,\n                attributionControl: false,\n                dragging: true,\n                touchZoom: true,\n                scrollWheelZoom: true\n            }).setView(geolocate.centerloc, zoomLevel);\n\n            // Add OpenStreetMap tiles\n            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n                attribution: false,\n                maxZoom: 19,\n                minZoom: 4,\n                preferCanvas: true\n            }).addTo(geolocate.map);\n\n            // Invalidate map size.\n            setTimeout(() => {\n                if (this.map) {\n                    this.map.invalidateSize();\n                }\n            }, 350);\n\n            Prefetch.prefetchTemplates(['local_courseindex/geomarker']);\n            log.debug('AMD courseindex geocode initialized');\n\n            // Locate all markers.\n            for (i = 0; i < geolocate.markers.length; i++) {\n                let m = geolocate.markers[i];\n                if (m.location != undefined && m.location != '') {\n                    // Only place explicit markers.\n                    let result = await geolocate.geocodeLocation(m.location);\n                    geolocate.markers[i].lon = result.lon;\n                    geolocate.markers[i].lat = result.lat;\n                    geolocate.markers[i].locname = result.name;\n                    geolocate.markers[i].locdisplayname = result.displayName;\n                    geolocate.addMarker(geolocate.markers[i]);\n                }\n            }\n\n            log.debug('AMD courseindex geocode markers initialized');\n            // Focus to region center.\n            geolocate.showLocation();\n        },\n\n        /**\n         * Geolocates using Nominatim API\n         * @param {string} locationName\n         */\n        geocodeLocation: async function(locationName) {\n            try {\n                const response = await fetch(\n                    'https://nominatim.openstreetmap.org/search?format=json&q=' +\n                    encodeURIComponent(locationName) + ',France&limit=1',\n                    {\n                        headers: {\n                            'User-Agent': 'MoodleFormationMap/1.0'\n                        }\n                    }\n                );\n\n                if (!response.ok) {\n                    throw new Error(geolocate.strs['notavailable']);\n                }\n\n                const data = await response.json();\n\n                if (data && data.length > 0) {\n                    return {\n                        lat: parseFloat(data[0].lat),\n                        lon: parseFloat(data[0].lon),\n                        name: data[0].name,\n                        displayName: data[0].display_name\n                    };\n                }\n                return null;\n            } catch (error) {\n                log.debug('Geocoding error :' + error);\n                return null;\n            }\n        },\n\n        /**\n         * Ajoute un marqueur sur la carte\n         * @param {object} marker\n         */\n        addMarker: async function(marker) {\n\n            // Create a custom icon.\n            const icon = L.icon({\n                iconUrl: cfg.wwwroot + '/local/courseindex/pix/location_with_alpha.png',\n                iconSize: [32, 40],\n                iconAnchor: [16, 40],\n                popupAnchor: [0, -40],\n                title: marker.location,\n                className: 'custom-marker'\n            });\n\n            // Create the marker.\n            Templates.render('local_courseindex/geomarker', {\n                    hascost: marker.hascost,\n                    cost: marker.cost,\n                    timestart: marker.timestart,\n                    timeend: marker.timeend,\n                    coursename: marker.course,\n                    location: marker.location,\n                    mode: marker.mode\n            }).then(function(html) {\n                log.debug(\"Setting marker popup for \" + marker.location);\n                geolocate.popupmarkers.push(L.marker([marker.lat, marker.lon], { icon: icon })\n                    .addTo(geolocate.map)\n                    .bindPopup(html, {\n                        maxWidth: 250,\n                        maxHeight: 250,\n                        className: 'custom-popup'\n                    }).openPopup());\n            }).catch((error) => {\n                log.debug(\"Could not resolve template for \" + marker.location + \" with error \" + error);\n            });\n\n            // Centrer et zoomer sur le marqueur.\n            geolocate.map.setView([marker.lat, marker.lon], 12);\n        },\n\n        /**\n         * Show the map poiting to a location\n         * @param {string} locationName\n         */\n        showLocation: async function(locationName) {\n\n            // If necessary.\n            geolocate.init();\n\n            const locationInfo = $('#locationInfo');\n            if (locationInfo) {\n                locationInfo.html(geolocate.strs['fetch']);\n            }\n\n            // Geocode location\n            const location = await geolocate.geocodeLocation(locationName);\n\n            if (location) {\n                geolocate.currentLocation = location;\n                geolocate.addMarker(location.lat, location.lon, location.name);\n                if (locationInfo) {\n                    locationInfo.html(location.name);\n                }\n            } else {\n                if (locationInfo) {\n                    locationInfo.html(geolocate.strs['notfound']);\n                }\n                log.warn(geolocate.strs['notfoundwarn'].replace('{{locname}}', locationName));\n            }\n        },\n\n        /**\n         * Escape HTML chars\n         * @param {string} text\n         */\n        escapeHtml: function(text) {\n\n            if (!text) {\n                return '';\n            }\n\n            const map = {\n                '&': '&amp;',\n                '<': '&lt;',\n                '>': '&gt;',\n                '\"': '&quot;',\n                \"'\": '&#039;'\n            };\n            return String(text).replace(/[&<>\"']/g, function(m) { return map[m]; });\n        },\n\n        /**\n         * Ouvre le modal avec la carte\n         * @param {string} locationName\n         */\n        openMap: function(locationName) {\n            const themap = $('#mapOverlay');\n            if (!themap) {\n                return;\n            }\n\n            themap.addClass('active');\n\n            geolocate.showLocation(locationName);\n        }\n\n    };\n\n    return geolocate;\n});"],"names":["define","$","Prefetch","Templates","Strings","log","cfg","geolocate","map","markers","Array","popupmarkers","centerloc","strs","init","async","data","zoomLevel","get_strings","key","component","then","results","defaultmapcenter","defaultcenterloc","defaultzoom","result","geocodeLocation","lat","lon","L","zoomControl","attributionControl","dragging","touchZoom","scrollWheelZoom","setView","tileLayer","attribution","maxZoom","minZoom","preferCanvas","addTo","setTimeout","this","invalidateSize","prefetchTemplates","debug","i","length","m","undefined","location","locname","name","locdisplayname","displayName","addMarker","showLocation","locationName","response","fetch","encodeURIComponent","headers","ok","Error","json","parseFloat","display_name","error","marker","icon","iconUrl","wwwroot","iconSize","iconAnchor","popupAnchor","title","className","render","hascost","cost","timestart","timeend","coursename","course","mode","html","push","bindPopup","maxWidth","maxHeight","openPopup","catch","locationInfo","currentLocation","warn","replace","escapeHtml","text","String","openMap","themap","addClass"],"mappings":"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"}