{"version":3,"file":"geolocate.min.js","sources":["../src/geolocate.js"],"sourcesContent":["\n/* eslint no-undef: \"off\" */\n\ndefine(['jquery', 'core/prefetch', 'core/templates', 'core/log'], function($, Prefetch, Templates, log) {\n\n    var geolocate = {\n\n        map: null,\n\n        markers: Array(),\n\n        popupmarkers: Array(),\n\n        /**\n         * Initialise la carte Leaflet\n         * @param {string} data\n         */\n        init: function(data) {\n            if (this.map) {\n                return;\n            }\n            log.debug(data);\n\n            var centerloc, zoomLevel;\n\n            this.markers = data.markers;\n            this.defaultmapcenter = data.defaultcenterloc;\n            this.defaultzoom = data.defaultzoom;\n            log.debug(\"map center \" + this.defaultmapcenter);\n            if (this.defaultmapcenter != '') {\n                var centerlocdata = geolocate.geocodeLocation(this.defaultmapcenter);\n                log.debug(centerlocdata);\n                centerloc = [centerlocdata.lat, centerlocdata.lon];\n            } else {\n                centerloc = [46.2276, 2.2137];\n            }\n\n            if (this.defaultzoom > 0) {\n                zoomLevel = this.defaultzoom;\n            } else {\n                zoomLevel = 6;\n            }\n            log.debug(\"map center \" + centerloc);\n\n            this.map = L.map('map', {\n                zoomControl: true,\n                attributionControl: false,\n                dragging: true,\n                touchZoom: true,\n                scrollWheelZoom: true\n            }).setView(centerloc, zoomLevel);\n\n            // Add OpenStreetMap tiles\n            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n                attribution: false,\n                maxZoom: 19,\n                minZoom: 4,\n                preferCanvas: true\n            }).addTo(this.map);\n\n            // Invalidate map size.\n            setTimeout(() => {\n                if (this.map) {\n                    this.map.invalidateSize();\n                }\n            }, 350);\n\n            Prefetch.prefetchTemplate('local_courseindex/geomarker');\n            log.debug('AMD courseindex geocode initialized');\n\n            // Locate all markers.\n            for (i = 0; i < this.markers.length; i++) {\n                let m = this.markers[i];\n                let locdata = geolocate.geocodeLocation(m.location);\n                this.markers[i].lon = locdata.lon;\n                this.markers[i].lat = locdata.lat;\n                this.markers[i].locname = locdata.name;\n                this.markers[i].locdisplayname = locdata.displayName;\n                geolocate.addMarker(this.markers[i]);\n            }\n\n            // Focus to region center\n            geolocate.showLocation();\n        },\n\n        /**\n         * Geolocates using Nominatim API\n         * @param {string} locationName\n         */\n        geocodeLocation: async function(locationName) {\n            try {\n                const response = await fetch(\n                    'https://nominatim.openstreetmap.org/search?format=json&q=' +\n                    encodeURIComponent(locationName) + ',France&limit=1',\n                    {\n                        headers: {\n                            'User-Agent': 'MoodleFormationMap/1.0'\n                        }\n                    }\n                );\n\n                if (!response.ok) {\n                    throw new Error('Network error');\n                }\n\n                const data = await response.json();\n\n                if (data && data.length > 0) {\n                    return {\n                        lat: parseFloat(data[0].lat),\n                        lon: parseFloat(data[0].lon),\n                        name: data[0].name,\n                        displayName: data[0].display_name\n                    };\n                }\n                return null;\n            } catch (error) {\n                log.debug('Geocoding error :' + error);\n                return null;\n            }\n        },\n\n        /**\n         * Ajoute un marqueur sur la carte\n         * @param {object} marker\n         */\n        addMarker: function(marker) {\n\n            // Create a custom icon.\n            const icon = L.icon({\n                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9' +\n                'zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDMyIDQwIj48cGF0aCBkPSJNMTYgMEM' +\n                '4LjI3IDAgMiA2LjI3IDIgMTRjMCA0IDAgMTggMTQgMjZzMTQtMjIgMTQtMjZjMC03LjczLTYuMjctMTQtMTQtM' +\n                'TR6TTEyIDIwYzAgMi4yMiAxLjc4IDQgNCA0czQtMS43OCA0LTQtMS43OC00LTQtNC00IDEuNzgtNCA0eiIgZml' +\n                'sbD0iIzY2N2VlYSIvPjwvc3ZnPg==',\n                iconSize: [32, 40],\n                iconAnchor: [16, 40],\n                popupAnchor: [0, -40],\n                title: marker.location,\n                className: 'custom-marker'\n            });\n\n            let popupContent = Templates.render('local_courseindex/geomarker', {\n                    hascost:marker.hascost,\n                    cost:marker.cost,\n                    timestart:marker.timestart,\n                    timeend:marker.timeend,\n                    coursename: marker.course,\n                    location: marker.location,\n                    mode: marker.mode\n            });\n\n            // Create the markers\n\n            this.popupmarkers.push(L.marker([marker.lat, marker.lon], { icon: icon })\n                .addTo(this.map)\n                .bindPopup(popupContent, {\n                    maxWidth: 250,\n                    maxHeight: 250,\n                    className: 'custom-popup'\n                }).openPopup());\n\n            // Centrer et zoomer sur le marqueur\n            this.map.setView([marker.lat, marker.lon], 12);\n        },\n\n        /**\n         * Show the map poiting to a location\n         * @param {string} locationName\n         */\n        showLocation: async function(locationName) {\n\n            this.initMap();\n\n            const locationInfo = $('#locationInfo');\n            if (locationInfo) {\n                locationInfo.html('G?olocalisation en cours...');\n            }\n\n            // Geocode location\n            const location = await this.geocodeLocation(locationName);\n\n            if (location) {\n                this.currentLocation = location;\n                this.addMarker(location.lat, location.lon, location.name);\n                if (locationInfo) {\n                    locationInfo.html('?? ' + location.name);\n                }\n            } else {\n                if (locationInfo) {\n                    locationInfo.html('Localisation non trouv?e');\n                }\n                log.warn('La localit? \"' + locationName + '\" n\\'a pas pu ?tre g?olocalis?e');\n            }\n        },\n\n        /**\n         * Escape HTML chars\n         * @param {string} text\n         */\n        escapeHtml: function(text) {\n\n            if (!text) {\n                return '';\n            }\n\n            const map = {\n                '&': '&amp;',\n                '<': '&lt;',\n                '>': '&gt;',\n                '\"': '&quot;',\n                \"'\": '&#039;'\n            };\n            return String(text).replace(/[&<>\"']/g, function(m) { return map[m]; });\n        },\n\n        /**\n         * Ouvre le modal avec la carte\n         * @param {string} locationName\n         */\n        openMap: function(locationName) {\n            const themap = $('#mapOverlay');\n            if (!themap) {\n                return;\n            }\n\n            themap.addClass('active');\n\n            geolocate.showLocation(locationName);\n        }\n\n    };\n\n    return geolocate;\n});"],"names":["define","$","Prefetch","Templates","log","geolocate","map","markers","Array","popupmarkers","init","data","this","centerloc","zoomLevel","debug","defaultmapcenter","defaultcenterloc","defaultzoom","centerlocdata","geocodeLocation","lat","lon","L","zoomControl","attributionControl","dragging","touchZoom","scrollWheelZoom","setView","tileLayer","attribution","maxZoom","minZoom","preferCanvas","addTo","setTimeout","invalidateSize","prefetchTemplate","i","length","m","locdata","location","locname","name","locdisplayname","displayName","addMarker","showLocation","async","locationName","response","fetch","encodeURIComponent","headers","ok","Error","json","parseFloat","display_name","error","marker","icon","iconUrl","iconSize","iconAnchor","popupAnchor","title","className","popupContent","render","hascost","cost","timestart","timeend","coursename","course","mode","push","bindPopup","maxWidth","maxHeight","openPopup","initMap","locationInfo","html","currentLocation","warn","escapeHtml","text","String","replace","openMap","themap","addClass"],"mappings":"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"}