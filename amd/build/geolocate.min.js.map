{"version":3,"file":"geolocate.min.js","sources":["../src/geolocate.js"],"sourcesContent":["\n/* eslint no-undef: \"off\" */\n\ndefine(['jquery', 'core/prefetch', 'core/templates',\n        'core/str', 'core/log', 'core/config'], function($, Prefetch, Templates, Strings, log, cfg) {\n\n    var geolocate = {\n\n        map: null,\n\n        markers: Array(),\n\n        popupmarkers: Array(),\n\n        centerloc: null,\n\n        strs: Array(),\n\n        /**\n         * Initialise la carte Leaflet\n         * @param {string} data\n         */\n        init: async function(data) {\n\n            if (this.map) {\n                return;\n            }\n\n            // Fetch some strings.\n            Strings.get_strings([{\n                key: 'geofetch',\n                component: 'local_courseindex'\n            }, {\n                key: 'geonotfound',\n                component: 'local_courseindex'\n            }, {\n                key: 'geonotfoundwarn',\n                component: 'local_courseindex'\n            }, {\n                key: 'geonotavailable',\n                component: 'local_courseindex'\n            }]).then(function(results) {\n                this.strs['fetch'] = results[0];\n                this.strs['notfound'] = results[1];\n                this.strs['notfoundwarn'] = results[2];\n                this.strs['notavailable'] = results[3];\n            });\n\n            var zoomLevel;\n\n            this.markers = data.markers;\n            this.defaultmapcenter = data.defaultcenterloc;\n            this.defaultzoom = data.defaultzoom;\n            if (this.defaultmapcenter != '') {\n                var result = await geolocate.geocodeLocation(this.defaultmapcenter);\n                this.centerloc = [result.lat, result.lon];\n            } else {\n                this.centerloc = [46.2276, 2.2137];\n            }\n\n            if (this.defaultzoom > 0) {\n                zoomLevel = this.defaultzoom;\n            } else {\n                zoomLevel = 8;\n            }\n\n            this.map = L.map('map', {\n                zoomControl: true,\n                attributionControl: false,\n                dragging: true,\n                touchZoom: true,\n                scrollWheelZoom: true\n            }).setView(this.centerloc, zoomLevel);\n\n            // Add OpenStreetMap tiles\n            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n                attribution: false,\n                maxZoom: 19,\n                minZoom: 4,\n                preferCanvas: true\n            }).addTo(this.map);\n\n            // Invalidate map size.\n            /*\n            setTimeout(() => {\n                if (this.map) {\n                    this.map.invalidateSize();\n                }\n            }, 350);\n            */\n\n            Prefetch.prefetchTemplate('local_courseindex/geomarker');\n            log.debug('AMD courseindex geocode initialized');\n\n            // Locate all markers.\n            for (i = 0; i < this.markers.length; i++) {\n                let m = this.markers[i];\n                let result = await geolocate.geocodeLocation(m.location);\n                geolocate.markers[i].lon = result.lon;\n                geolocate.markers[i].lat = result.lat;\n                geolocate.markers[i].locname = result.name;\n                geolocate.markers[i].locdisplayname = result.displayName;\n                geolocate.addMarker(geolocate.markers[i]);\n            }\n\n            log.debug('AMD courseindex geocode markers initialized');\n            // Focus to region center.\n            geolocate.showLocation();\n        },\n\n        /**\n         * Geolocates using Nominatim API\n         * @param {string} locationName\n         */\n        geocodeLocation: async function(locationName) {\n            try {\n                const response = await fetch(\n                    'https://nominatim.openstreetmap.org/search?format=json&q=' +\n                    encodeURIComponent(locationName) + ',France&limit=1',\n                    {\n                        headers: {\n                            'User-Agent': 'MoodleFormationMap/1.0'\n                        }\n                    }\n                );\n\n                if (!response.ok) {\n                    throw new Error(geolocate.strs['notavailable']);\n                }\n\n                const data = await response.json();\n\n                if (data && data.length > 0) {\n                    return {\n                        lat: parseFloat(data[0].lat),\n                        lon: parseFloat(data[0].lon),\n                        name: data[0].name,\n                        displayName: data[0].display_name\n                    };\n                }\n                return null;\n            } catch (error) {\n                log.debug('Geocoding error :' + error);\n                return null;\n            }\n        },\n\n        /**\n         * Ajoute un marqueur sur la carte\n         * @param {object} marker\n         */\n        addMarker: async function(marker) {\n\n            // Create a custom icon.\n            const icon = L.icon({\n                iconUrl: cfg.wwwroot + '/local/courseindex/pix/location/jpg',\n                iconSize: [32, 40],\n                iconAnchor: [16, 40],\n                popupAnchor: [0, -40],\n                title: marker.location,\n                className: 'custom-marker'\n            });\n\n            // Create the marker.\n            Templates.render('local_courseindex/geomarker', {\n                    hascost:marker.hascost,\n                    cost:marker.cost,\n                    timestart:marker.timestart,\n                    timeend:marker.timeend,\n                    coursename: marker.course,\n                    location: marker.location,\n                    mode: marker.mode\n            }).then(function(html) {\n                geolocate.popupmarkers.push(L.marker([marker.lat, marker.lon], { icon: icon })\n                    .addTo(geolocate.map)\n                    .bindPopup(html, {\n                        maxWidth: 250,\n                        maxHeight: 250,\n                        className: 'custom-popup'\n                    }).openPopup());\n            });\n\n            // Centrer et zoomer sur le marqueur\n            this.map.setView([marker.lat, marker.lon], 12);\n        },\n\n        /**\n         * Show the map poiting to a location\n         * @param {string} locationName\n         */\n        showLocation: async function(locationName) {\n\n            // If necessary.\n            geolocate.init();\n\n            const locationInfo = $('#locationInfo');\n            if (locationInfo) {\n                locationInfo.html(geolocate.strs['fetch']);\n            }\n\n            // Geocode location\n            const location = await geolocate.geocodeLocation(locationName);\n\n            if (location) {\n                geolocate.currentLocation = location;\n                geolocate.addMarker(location.lat, location.lon, location.name);\n                if (locationInfo) {\n                    locationInfo.html(location.name);\n                }\n            } else {\n                if (locationInfo) {\n                    locationInfo.html(geolocate.strs['notfound']);\n                }\n                log.warn(geolocate.strs['notfoundwarn'].replace('{{locname}}', locationName));\n            }\n        },\n\n        /**\n         * Escape HTML chars\n         * @param {string} text\n         */\n        escapeHtml: function(text) {\n\n            if (!text) {\n                return '';\n            }\n\n            const map = {\n                '&': '&amp;',\n                '<': '&lt;',\n                '>': '&gt;',\n                '\"': '&quot;',\n                \"'\": '&#039;'\n            };\n            return String(text).replace(/[&<>\"']/g, function(m) { return map[m]; });\n        },\n\n        /**\n         * Ouvre le modal avec la carte\n         * @param {string} locationName\n         */\n        openMap: function(locationName) {\n            const themap = $('#mapOverlay');\n            if (!themap) {\n                return;\n            }\n\n            themap.addClass('active');\n\n            geolocate.showLocation(locationName);\n        }\n\n    };\n\n    return geolocate;\n});"],"names":["define","$","Prefetch","Templates","Strings","log","cfg","geolocate","map","markers","Array","popupmarkers","centerloc","strs","init","async","data","this","zoomLevel","get_strings","key","component","then","results","defaultmapcenter","defaultcenterloc","defaultzoom","result","geocodeLocation","lat","lon","L","zoomControl","attributionControl","dragging","touchZoom","scrollWheelZoom","setView","tileLayer","attribution","maxZoom","minZoom","preferCanvas","addTo","prefetchTemplate","debug","i","length","m","location","locname","name","locdisplayname","displayName","addMarker","showLocation","locationName","response","fetch","encodeURIComponent","headers","ok","Error","json","parseFloat","display_name","error","marker","icon","iconUrl","wwwroot","iconSize","iconAnchor","popupAnchor","title","className","render","hascost","cost","timestart","timeend","coursename","course","mode","html","push","bindPopup","maxWidth","maxHeight","openPopup","locationInfo","currentLocation","warn","replace","escapeHtml","text","String","openMap","themap","addClass"],"mappings":"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"}